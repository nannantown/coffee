name: iOS Build & TestFlight

on:
  push:
    tags:
      - 'v*'  # Run only on version tags to minimize macOS runner usage

jobs:
  build-ios:
    name: Build & Upload to TestFlight
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.x'
        channel: 'stable'
        cache: true

    - name: Get dependencies
      run: flutter pub get

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
        bundler-cache: true
        working-directory: ios

    - name: Install Fastlane
      run: |
        cd ios
        gem install fastlane

    - name: Setup SSH for Match
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.MATCH_GIT_PRIVATE_KEY }}

    - name: Configure Match
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
      run: |
        cd ios
        # Match will fetch certificates from the git repository
        fastlane match appstore --readonly

    - name: Build iOS (Flutter)
      run: flutter build ios --release --no-codesign

    - name: Build & Upload to TestFlight
      env:
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        FASTLANE_APPLE_ID: ${{ secrets.FASTLANE_APPLE_ID }}
        FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        MATCH_PROFILE_NAME: "match AppStore com.example.account_template"
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
      run: |
        cd ios
        fastlane beta

    - name: Upload IPA artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: ios/*.ipa
        if-no-files-found: warn
        retention-days: 30
